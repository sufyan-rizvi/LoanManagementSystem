@model LoanManagementSystem.Models.LoanApplication
@{
    ViewBag.Title = "Razorpay Payment Page";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Pay with Razorpay</h2>

<form id="payment-form" action="/Payment/ProcessPayment" method="POST">
    <div class="form-group">
        <label for="amount">Enter Amount (in $):</label>
        <input type="number" id="amount" name="amount" class="form-control" readonly value="@Model.EMIAmount" required />
    </div>
    <input type="hidden" id="rzp_payment_id" name="rzp_payment_id" />
    <input type="hidden" id="rzp_order_id" name="rzp_order_id" />
    <input type="hidden" id="rzp_signature" name="rzp_signature" />

    <button type="button" id="rzp-button1" class="btn btn-primary">Pay Now</button>
</form>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    document.getElementById('rzp-button1').onclick = function (e) {
        var amount = document.getElementById('amount').value;

        if (amount < 1) {
            alert("Please enter a valid amount!");
            return;
        }

        // Make a server request to get the order ID for the amount entered
        fetch('/Payment/CreateOrder?amount=' + amount)
            .then(response => response.json())
            .then(data => {
                var options = {
                    "key": "@System.Configuration.ConfigurationManager.AppSettings["RazorpayKey"]",
                    "amount": data.amount, // Amount is in paise
                    "currency": "Dollar",
                    "name": "Test Payment",
                    "description": "Testing Razorpay Payment",
                    "image": "https://yourlogo.com/logo.png",
                    "order_id": data.orderId, // Order ID generated by the server
                    "handler": function (response) {
                        document.getElementById('rzp_payment_id').value = response.razorpay_payment_id;
                        document.getElementById('rzp_order_id').value = response.razorpay_order_id;
                        document.getElementById('rzp_signature').value = response.razorpay_signature;
                        document.forms[0].submit();
                    },
                    "prefill": {
                        "name": "Test User",
                        "email": "testuser@example.com",
                        "contact": "9999999999"
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                };

                var rzp1 = new Razorpay(options);
                rzp1.open();
            })
            .catch(error => {
                console.error("Error creating order:", error);
                alert("Failed to initiate payment.");
            });

        e.preventDefault();
    };
</script>

